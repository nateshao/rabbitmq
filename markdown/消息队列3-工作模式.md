# 【消息队列】RabbitMQ四种工作模式

# 一、工作队列模式

![](https://nateshao-blog.oss-cn-shenzhen.aliyuncs.com/wximage-20240529214928542.png)

**注意**：运行的时候先启动消费者1，2程序，然后再启动生产者端程序。<br/>
如果已经运行过生产者程序，则手动把work_queue队列删掉。<br/>

## 1 生产者

**1、封装工具类：ConnectionUtil.class**

```java
package com.nateshao.work_queue.util;

import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;
/**
 * @Author 千羽
 * @公众号 程序员千羽
 * @Date 2024/5/29 16:00
 * @Version 1.0
 */
public class ConnectionUtil {
    public static final String HOST_ADDRESS = "localhost";

    public static Connection getConnection() throws Exception {

        // 定义连接工厂
        ConnectionFactory factory = new ConnectionFactory();

        // 设置服务地址
        factory.setHost(HOST_ADDRESS);

        // 端口
        factory.setPort(5672);

        //设置账号信息，用户名、密码、vhost
        factory.setVirtualHost("/");
        factory.setUsername("guest");
        factory.setPassword("123456");

        // 通过工程获取连接
        Connection connection = factory.newConnection();

        return connection;
    }

    public static void main(String[] args) throws Exception {
        Connection con = ConnectionUtil.getConnection();
        // amqp://guest@localhost:5672/
        System.out.println(con);
        con.close();
    }
}
```

### 1.2 编写代码

Producer.class

```java
package com.nateshao.work_queue;

import com.nateshao.work_queue.util.ConnectionUtil;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
/**
 * @Author 千羽
 * @公众号 程序员千羽
 * @Date 2024/5/29 16:00
 * @Version 1.0
 */
public class Producer {

    public static final String QUEUE_NAME = "work_queue";

    public static void main(String[] args) throws Exception {

        Connection connection = ConnectionUtil.getConnection();

        Channel channel = connection.createChannel();

        channel.queueDeclare(QUEUE_NAME, true, false, false, null);

        for (int i = 1; i <= 10; i++) {

            String body = i + "hello rabbitmq~~~";

            channel.basicPublish("", QUEUE_NAME, null, body.getBytes());

        }

        channel.close();
        connection.close();
    }
}
```

### 1.3 发送消息效果

![](https://nateshao-blog.oss-cn-shenzhen.aliyuncs.com/wximage-20240529214118054.png)

## 2 消费者

### 2.1 编写代码

创建Consumer1和Consumer2。Consumer2只是类名和打印提示不同，代码完全一样。

Consumer1.class

```java
package com.nateshao.work_queue;

import com.nateshao.work_queue.util.ConnectionUtil;
import com.rabbitmq.client.*;

import java.io.IOException;
/**
 * @Author 千羽
 * @公众号 程序员千羽
 * @Date 2024/5/29 16:00
 * @Version 1.0
 */
public class Consumer1 {

    static final String QUEUE_NAME = "work_queue";

    public static void main(String[] args) throws Exception {

        Connection connection = ConnectionUtil.getConnection();

        Channel channel = connection.createChannel();

        channel.queueDeclare(QUEUE_NAME, true, false, false, null);

        Consumer consumer = new DefaultConsumer(channel) {

            @Override
            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException {

                System.out.println("Consumer1 body：" + new String(body));

            }

        };
        channel.basicConsume(QUEUE_NAME, true, consumer);
    }
}
```



Consumer2.class

```java
package com.nateshao.work_queue;

import com.nateshao.work_queue.util.ConnectionUtil;
import com.rabbitmq.client.*;

import java.io.IOException;
/**
 * @Author 千羽
 * @公众号 程序员千羽
 * @Date 2024/5/29 16:00
 * @Version 1.0
 */
public class Consumer2 {

    static final String QUEUE_NAME = "work_queue";

    public static void main(String[] args) throws Exception {

        Connection connection = ConnectionUtil.getConnection();

        Channel channel = connection.createChannel();

        channel.queueDeclare(QUEUE_NAME, true, false, false, null);

        Consumer consumer = new DefaultConsumer(channel) {

            @Override
            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException {
                System.out.println("Consumer1 body：" + new String(body));
            }
        };
        channel.basicConsume(QUEUE_NAME, true, consumer);
    }
}
```

### 2.2 运行效果

最终两个消费端程序竞争结果如下：<br/>

![](https://nateshao-blog.oss-cn-shenzhen.aliyuncs.com/wximage-20240529214617491.png)

